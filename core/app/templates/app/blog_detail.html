{% extends "app/base.html" %}
{% load static %}

{% block title %}{{ post.title }} | Blog | {{ company.company_name|default:'Blue Diamond Service Center' }}{% endblock %}
{% block content %}

{% url 'blog_list' as blog_list_url %}
{% include 'app/components/page_header.html' with title=post.title parent_title='Blog' parent_url=blog_list_url subtitle=post.published_at|date:'F d, Y' %}

<section class="blog-detail-section">
	<div class="container">
		<div class="row">
			<div class="col-lg-8 col-md-12">
				<article class="blog-detail">

					{% if post.cover_image %}
					<div class="post-cover">
						<img src="{{ post.cover_image.url }}" alt="{{ post.title }}">
					</div>
					{% endif %}

					<div class="post-content">
						{{ post.content|safe }}
					</div>

					<footer class="post-footer">
						<div class="post-nav">
							{% if prev_post %}
							<a class="prev" href="{% url 'blog_detail' prev_post.slug %}">← {{ prev_post.title|truncatechars:40 }}</a>
							{% endif %}
							{% if next_post %}
							<a class="next" href="{% url 'blog_detail' next_post.slug %}">{{ next_post.title|truncatechars:40 }} →</a>
							{% endif %}
						</div>
					</footer>
				</article>
			</div>

			<div class="col-lg-4 col-md-12">
				{% if recent_posts %}
				<div style="position: relative;">
					<aside class="sidebar sticky-sidebar">
						<div class="sidebar-widget">
						<h3 class="widget-title">Recent Posts</h3>
						<ul class="recent-posts">
							{% for rp in recent_posts %}
							<li>
								<a href="{% url 'blog_detail' rp.slug %}">
									<div class="recent-post-image">
										{% if rp.cover_image %}
											<img src="{{ rp.cover_image.url }}" alt="{{ rp.title }}">
										{% else %}
											<img src="{% static 'app/bluediamondservicecenter/home/image3.jpg' %}" alt="{{ rp.title }}">
										{% endif %}
									</div>
									<div class="recent-post-content">
										<span class="title">{{ rp.title|truncatechars:60 }}</span>
										<span class="date">{{ rp.published_at|date:'M d, Y' }}</span>
									</div>
								</a>
							</li>
							{% endfor %}
						</ul>
					</div>
				</aside>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</section>

<style>
.blog-detail-section { padding: 60px 0; background: #fff; }
.blog-detail { background: #fff; border-radius: 20px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
.post-header { margin-bottom: 15px; }
.post-cover { margin: 20px 0 25px; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(0,0,0,0.08); }
.post-cover img { width: 100%; height: auto; display: block; }
.post-content { color: #374151; line-height: 1.8; font-size: 1.05rem; }
.post-footer { margin-top: 30px; border-top: 1px solid #e5e7eb; padding-top: 20px; }
.post-nav { display: flex; justify-content: space-between; }
.post-nav a { color: #1e3c72; text-decoration: none; font-weight: 600; }
.post-nav a:hover { color: #2a5298; }

.sidebar .sidebar-widget { background: #fff; border-radius: 20px; padding: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); }
.widget-title { font-weight: 700; color: #1e293b; margin: 0 0 20px; }
.recent-posts { list-style: none; padding: 0; margin: 0; }
.recent-posts li { padding: 15px 0; border-bottom: 1px solid #f1f5f9; }
.recent-posts li:first-child { padding-top: 0; }
.recent-posts li:last-child { border-bottom: none; padding-bottom: 0; }
.recent-posts a { display: flex; align-items: flex-start; gap: 15px; text-decoration: none; transition: all 0.3s ease; }
.recent-posts a:hover { transform: translateX(5px); }
.recent-post-image { flex-shrink: 0; width: 80px; height: 60px; overflow: hidden; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
.recent-post-image img { width: 100%; height: 100%; object-fit: cover; transition: transform 0.3s ease; }
.recent-posts a:hover .recent-post-image img { transform: scale(1.1); }
.recent-post-content { flex: 1; display: flex; flex-direction: column; gap: 6px; min-width: 0; }
.recent-posts .title { display: block; color: #1e293b; font-weight: 600; line-height: 1.4; overflow: hidden; text-overflow: ellipsis; }
.recent-posts .date { display: block; color: #64748b;  }

@media (max-width: 768px) {
	.blog-detail { padding: 20px; }
}
</style>

<script>
// Sticky sidebar - intelligent behavior based on sidebar height
$(document).ready(function(){
    var $sidebar = $('.sticky-sidebar');
    var $sidebarWrapper = $sidebar.parent();
    var $contentColumn = $('.blog-detail').closest('.col-lg-8');
    var lastScrollTop = 0;
    var isSticky = false;
    var stickyTop = 0;
    
    if ($sidebar.length && $contentColumn.length) {
        function updateSidebar() {
            // Only apply sticky behavior on desktop (width > 991px)
            if ($(window).width() <= 991) {
                // Reset to static on mobile/tablet
                $sidebar.css({
                    'position': 'static',
                    'width': 'auto',
                    'top': 'auto',
                    'bottom': 'auto'
                });
                return;
            }
            
            var scrollTop = $(window).scrollTop();
            var windowHeight = $(window).height();
            var sidebarHeight = $sidebar.outerHeight();
            var sidebarTop = $sidebarWrapper.offset().top;
            var sidebarBottom = sidebarTop + sidebarHeight;
            var contentBottom = $contentColumn.offset().top + $contentColumn.outerHeight();
            var scrollDirection = scrollTop > lastScrollTop ? 'down' : 'up';
            
            var stopPoint = contentBottom - sidebarHeight - 20;
            var headerOffset = 100; // Offset for fixed header
            
            // Check if sidebar is shorter than viewport
            var isSidebarShort = sidebarHeight < windowHeight;
            
            if (isSidebarShort) {
                // SHORT SIDEBAR: Always stick to top
                var startPoint = sidebarTop - headerOffset;
                
                if (scrollTop >= startPoint && scrollTop < stopPoint) {
                    // Fixed to viewport top
                    $sidebar.css({
                        'position': 'fixed',
                        'top': headerOffset + 'px',
                        'bottom': 'auto',
                        'width': $sidebarWrapper.width() + 'px'
                    });
                } else if (scrollTop >= stopPoint) {
                    // Absolute at bottom of content
                    var absoluteTop = contentBottom - sidebarTop - sidebarHeight - 20;
                    $sidebar.css({
                        'position': 'absolute',
                        'top': absoluteTop + 'px',
                        'bottom': 'auto',
                        'width': $sidebarWrapper.width() + 'px'
                    });
                } else {
                    // Static at initial position
                    $sidebar.css({
                        'position': 'static',
                        'width': 'auto',
                        'top': 'auto',
                        'bottom': 'auto'
                    });
                }
            } else {
                // TALL SIDEBAR: Stick to bottom when scrolling down
                var startPoint = sidebarBottom - windowHeight;
                
                // If scrolling up and we're above the start point, reset to static
                if (scrollDirection === 'up' && scrollTop < startPoint) {
                    isSticky = false;
                    $sidebar.css({
                        'position': 'static',
                        'width': 'auto',
                        'top': 'auto',
                        'bottom': 'auto'
                    });
                }
                // If at or past stop point, lock at bottom of content
                else if (scrollTop >= stopPoint) {
                    isSticky = false;
                    var absoluteTop = contentBottom - sidebarTop - sidebarHeight - 20;
                    $sidebar.css({
                        'position': 'absolute',
                        'top': absoluteTop + 'px',
                        'bottom': 'auto',
                        'width': $sidebarWrapper.width() + 'px'
                    });
                }
                // In sticky zone
                else if (scrollTop >= startPoint) {
                    if (scrollDirection === 'down') {
                        // Fixed to viewport bottom when scrolling down
                        isSticky = true;
                        stickyTop = scrollTop;
                        $sidebar.css({
                            'position': 'fixed',
                            'bottom': '0px',
                            'top': 'auto',
                            'width': $sidebarWrapper.width() + 'px'
                        });
                    } else if (scrollDirection === 'up' && isSticky) {
                        // Keep sticky while scrolling up in sticky zone
                        $sidebar.css({
                            'position': 'fixed',
                            'bottom': '0px',
                            'top': 'auto',
                            'width': $sidebarWrapper.width() + 'px'
                        });
                    }
                }
                // Below start point (initial area)
                else {
                    isSticky = false;
                    $sidebar.css({
                        'position': 'static',
                        'width': 'auto',
                        'top': 'auto',
                        'bottom': 'auto'
                    });
                }
            }
            
            lastScrollTop = scrollTop;
        }
        
        $(window).on('scroll resize', updateSidebar);
        updateSidebar(); // Initial call
    }
});
</script>

{% endblock %}
